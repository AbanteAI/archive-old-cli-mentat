<!DOCTYPE html>
<html>
    <head></head>
    <body>
        <div class="container">
            <div class="left-viewer viewer">
                <h1 class="history-title">Conversation History</h1>
            </div>
            <div class="right-viewer viewer">
                <h1 class="viewpoint-title">Model's Viewpoint</h1>
            </div>
        </div>
    </body>
    <script>
        function clear_messages() {
            document.querySelectorAll('.message').forEach(element => element.remove());
        }

        function append_message(message, messageDiv) {
            if (typeof message.content === 'string') {
                const p = document.createElement("p")
                p.innerHTML = message.content.replace(/\n/g, "<br>")
                messageDiv.appendChild(p)
            } else {
                for (part of message.content) {
                    if (part.type == "text") {
                        const p = document.createElement("p")
                        p.innerHTML = part.text.replace(/\n/g, "<br>")
                        messageDiv.appendChild(p)
                    } else if (part.type == "image_url") {
                        const image = document.createElement("img")
                        image.src = part.image_url.url
                        messageDiv.appendChild(image)
                    }
                }
            }
            messageDiv.classList.add("message")
            const role = message["role"]
            messageDiv.classList.add(role)
        }

        function display_transcript(transcript) {
            timestamp = transcript[0]
            messages = transcript[1]

            const viewTitle = document.getElementsByClassName("viewpoint-title")[0]
            viewTitle.innerHTML = "Model's Viewpoint: " + timestamp


            const leftViewer = document.getElementsByClassName("left-viewer")[0]
            for(message of messages) {
                const messageDiv = document.createElement("div")

                if (typeof message[0] === 'string') {
                    current_message = JSON.parse(message[0])
                } else {
                    current_message = message[0]
                }


                append_message(current_message, messageDiv)

                const role = current_message["role"]
                if(role == "assistant") {
                    messageDiv.classList.add("clickable")
                    const modelMessages = message[1]
                    messageDiv.onclick = (event) => {
                        for(selected of document.getElementsByClassName("selected")) {
                            selected.classList.remove("selected")
                        }
                        messageDiv.classList.add("selected")
                        openModelMessage(modelMessages)
                    }
                }
                leftViewer.appendChild(messageDiv)
            }
        }

        function openModelMessage(modelMessages) {
            const rightViewer = document.getElementsByClassName("right-viewer")[0]
            document.querySelectorAll('.viewpoint-message').forEach(element => element.remove());
            for(message of modelMessages) {
                const messageDiv = document.createElement("div")
                const messageText = document.createElement("p")
                const parsed_message = JSON.parse(message)
                append_message(parsed_message, messageDiv)
                messageDiv.classList.add("viewpoint-message")
                rightViewer.appendChild(messageDiv)
            }
        }

        const transcripts = {{ messages }}
        var at = 0
        display_transcript(transcripts[0])

        document.addEventListener('keydown', function(event) {
            switch (event.key) {
                case 'ArrowLeft':
                    if (at == 0) {
                        break;
                    }
                    at = at - 1
                    clear_messages()
                    display_transcript(transcripts[at])
                    break;
                case 'ArrowRight':
                    if (at == transcripts.length - 1) {
                        break;
                    }
                    at = at + 1
                    clear_messages()
                    display_transcript(transcripts[at])
                    break;
            }
        })

    </script>
    <style>
html {
    height: 100%;
    font-size: 24px;
    font-family: monospace;
}

        body {
            height: 100%;
            padding: 0;
            margin: 0;
            display: flex;
        }

        h1 {
            margin: 10 0px;
        }

        .container {
            width: 100%;
            display: flex;
            flex-direction: row;
        }

        .viewer {
            border: 1px solid black;
            overflow: auto;
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .left-viewer {
            background-color: rgb(228, 254, 255);
            resize: horizontal;
            width: 20%;
            min-width: 10%;
            max-width: 90%;
        }

        .right-viewer {
            background-color: rgb(220, 220, 220);
        }

        .message {
            padding: 8px;
            border: 1px solid black;
            overflow: auto;
            max-height: 500px;
            text-align: left;
        }

        .system {
            background-color: rgb(203, 203, 203);
            margin-left: auto;
            margin-right: auto;
        }

        .user {
            background-color: rgb(187, 236, 255);
            margin-left: auto;
        }

        .assistant {
            transition: background-color 0.2s;
            background-color: rgb(204, 243, 204);
            margin-right: auto;
        }

        .clickable {
            user-select: none;
        }

        .selected,
        .clickable:hover {
            background-color: rgb(245, 245, 245);
        }

        .selected,
        .selected:hover {
            background-color: rgb(255, 255, 255);
        }
    </style>
</html>
